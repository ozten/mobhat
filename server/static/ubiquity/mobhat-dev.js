/** 
 * DO NOT EDIT THIS FILE DIRECTLY!
 *
 * oface.js is generated from several individual source files in ubiquity-sources/
 * of the oface project...
 *
 * See build.js
 */
;Oface = Oface || {};
Oface.Page = Oface.Page || {};
CmdUtils.onPageLoad(function(){
    CmdUtils.injectCss("\
.cluster-facet-widget-panel{float: right; position: relative; top: -25px; width: 300px;}\
#welcome-new-user-panel{\
  position: absolute; top: 0px; border: solid 3px #999;\
  padding: 25px;\
  background-color: #DDD;\
}\
.group-facet span.count{\
  background-image: url(http://mobhat.restservice.org/static/images/ubiquity/BowlerIcon39x27.png);\
  background-repeat: no-repeat;\
  display: block;\
  width: 39px;\
  right: 42px;\
  position: relative;\
  color: rgb(255, 255, 255);\
  text-align: center;\
  padding-top: 3px;\
  height: 27px;\
  top: -20px;\
}\
#oface-other-facets{\
  margin-top: 18px\
}\
#oface-enabler{\
  cursor: pointer;\
}\
#facet-toggler{\
  cursor: context-menu;\
}\
.facet-name{\
  color: blue;\
  text-decoration: underline;\
  cursor: pointer;\
}\
\
#switcher-progress-panel{\
  background-color: #FFF;\
  position: absolute;\
  text-alighn: center;\
}\
#switcher-progress-panel img{\
  padding: 2.5em;\
}\
\
.unknown-entry{\
  background-color: #DEF;\
  background-image: url(http://mobhat.restservice.org/static/images/ubiquity/UnknowFacet.png);\
  background-repeat: no-repeat;\
}\
.ls-entry-facet-menu-item{\
  background-image:url(http://mobhat.restservice.org/static/images/favicon.gif);\
  background-repeat:no-repeat;\
  padding-left:18px;\
}\
");
});;var Oface = Oface || {};
Oface.HOST = "http://mobhat.restservice.org";
             //"http://oface.ubuntu";;

function logError(msg, debugObjects) {
  Oface.log("ERROR:" + msg);
  for(var i=0; i <= debugObjects.length; i++) {
    Oface.log(debugObjects[i]);
  }
};
var Oface = Oface || {};
Oface.version = 13;
Oface.log = function() {
    var args = Array.prototype.slice.call(arguments);
    try {
        CmdUtils.log.apply(CmdUtils, args);
    } catch (e) {
        CmdUtils.log("ERROR: Unable to log that object", e);
    }
}
Oface.Util = Oface.Util || {
    noOp: function(event) {
        //no op
    },
    ajax: function(options) {
        var numRetry = 5;
        var origError = options['error'];
        options['error'] = function(xhr, status, error) {
            var numRetries = parseInt( numRetry );
            if(500 == parseInt(xhr.status) && numRetries != NaN && numRetries > 1) {
                Oface.log("Caught a server error " + numRetry);    
                numRetry = numRetries - 1;
                retryAjax();
            } else {
                Oface.log('Out of retries, or real error ' + xhr.status);
                if(origError) {
                    origError(xhr, status, error);
                }
            }
        };
        function retryAjax(){
            jQuery.ajax(options);
        };
        retryAjax();
    }
};
/**
* Event System consumers listen for events and
* producers create events
            whenWeSee('lifestream-entries-info-available', function(event, urlInfos){
              Oface.log("We're golden BRO ", urlInfos);
              });
            whenWeSee('lifestream-entries-info-available', {foo: 'bar'}, function(event, urlInfos){
              Oface.log("We're golden BRO and we've got foo", event.data.foo, urlInfos);
              });
            triggerA('lifestream-entries-info-available', {urlInfos: data});
*/

function whenWeSee(eventName, eventData, fn){
    if(eventData) {
        jQuery(Application.activeWindow.activeTab.document).bind(eventName, eventData, fn);
    } else {
        jQuery(Application.activeWindow.activeTab.document).bind(eventName, fn);
    }
}

function triggerA(eventName, callbackParam){
    callbackParam = callbackParam || {};
    jQuery(Application.activeWindow.activeTab.document).trigger(eventName, callbackParam);
};var identity = null;
;var Oface = Oface || {};
Oface.Models = Oface.Models || {};
Oface.Models.UserDB = {
    whoAmI: function(oface, FTW, FAIL){
        /**
         * TODO get rid of oface argmument which is a acontext object
         */
        //jQuery.ajax({
        Oface.Util.ajax({
            type: "GET",
            url: Oface.HOST + "/users/whoami?cache_bust=" + escape(new Date()),
            async: false,
            cache: false,
            dataType: "json",
            success: FTW,
            error: FAIL
        }, Application.activeWindow.activeTab.document);
    }
}
;var Oface = Oface || {};
Oface.Models = Oface.Models || {};
Oface.Models.ResourceDB = {
    queryFacets: function(urls, FTW, FAIL) {
        var query = { urls: urls };
        Oface.log("ENCODEJSON queryFacets", query);        
        var dataPayload = "q=" + Utils.encodeJson(query);
        Oface.Util.ajax({
            url: Oface.HOST + '/resources/query_facets',
            type: 'POST',
            dataType: 'json',
            cache: false, // REMOVE FOR PROD
            data: dataPayload,
            success: FTW,
            error: FAIL      
        }, Application.activeWindow.activeTab.document);
    }
};var Oface = Oface || {};
Oface.Views = Oface.Views || {};
Oface.Views.userFacetToggler =
<div><h3 id='oface-enabler' style='float: left' title='Click to Change'>
        <img src="http://mobhat.restservice.org/static/images/ubiquity/mobhat-logo-sm.png" width="93" height="17" title="MOBhat" /> is
    <span class='status'>Enabled</span>
    <img src='http://mobhat.restservice.org/static/images/dell_icon-power-button.gif'
         style='vertical-align: bottom' width='16' height='16' title="Power Switch for MOBHat" />
                               
    </h3>
                              
    <div id="facet-toggler" class='current-facet' ><div style="margin-top:18px; margin-left: 3px; float:left"></div>
        <div class='switcher-arrow' style='margin-top:20px; float: left; height:6px; width:7px; margin-left:3px; font-size:0; vertical-align:middle; background:transparent url(http://mobhat.restservice.org/static/images/gmail_downarros.png) no-repeat scroll -36px 50%;'> x</div>
    </div>
</div>.children();; //TODO restructure this...
var Oface = Oface || {};
Oface.Views = Oface.Views || {};
Oface.Views.pageFacetToggler =
  <ul id='oface-other-facets' style='float: left; list-style-type: none;'></ul>;

Oface.Views.pageFacetTogglerLabel =
  <li style='display: inline; margin-right: 0.5em; float: left'>Hidden Below:</li>;
  
Oface.Views.pageFacetTogglerResetLabel = function(tab){
    jQuery('#oface-other-facets li', tab.document).remove();
    return jQuery('#oface-other-facets', tab.document).append(Oface.Views.pageFacetTogglerLabel.toXMLString());
};
  
Oface.Views.addPageFacetTogglerAddFacet = function(facet, count, tab) {
    var li = jQuery("<li class='oface-enabler-" + facet + "-other page-facet " + facet +
                    "' style='display: inline; margin-right: 0.5em; float: left;'><span class='facet-name'>" +
                    facet + "</span> <span class='count'>" + count + "</span></li>", tab.document);
    jQuery('#oface-other-facets', tab.document).append(li);
    return li;
};var Oface = Oface || {};
Oface.Views = Oface.Views || {};
Oface.Views.loginForm = <form id="oface-login-form"
                  style="position: fixed; top: 100px; left: 100px; z-index: 666; background-color: #FFF; color: #333">
                          <div>
                            <h1>MobHat requires a Login:</h1>
                            <p id="message">Please sir, can I have some more porage?</p>
                            Username: <input type="text" value="" name="username" id="username" /><br />
                            Password: <input type="password" value="" name="password" id="password" /><br />
                            <input type="submit" value="Login" name="submit" id="submit" />
                            <input type="submit" value="Cancel" name="cancel" id="cancel" />
                            <p>Need an account? <a id="login-signup-url" href="REPLACED">Sign Up</a></p>
                          </div>
                        </form>;;Oface = Oface || {};
Oface.Views = Oface.Views || {};
Oface.Views.welcomeNewUser = <div id="welcome-new-user-panel"><img src="http://mobhat.restservice.org/static/images/ubiquity/mobhat-logo-sm.png" width="97" height="17"
				   alt="MOBHat Logo"
                   title="MOBHat" border="0" /><h3>Welcome <span id="new-user-name">Friend</span></h3>
  <p>To kick things off, I need you to choose your first &quot;Hat&quot;.
    Who is your audiences, right now? BreadMakers, Pundits, Webdevs, etc.</p>
  <form>I'm wearing my <input type="text" id="facetinput" name="facetinput" size="15" value="InternetGeek" /> Hat.
      <input type="submit" value="Ok" />
  </form>
</div>.toXMLString();;var Oface = Oface || {};
Oface.Models = Oface.Models || {};
Oface.Models.AskForLogin = {
    authDemoLogin: function(doc, oface, retries){
        Oface.log("Retries left: ", retries);
      //TODO validate
      //TODO handle bad login...
      var formData = { username: $('#oface-login-form #username', doc).attr('value'),
                       password: $('#oface-login-form #password', doc).attr('value') };
      Oface.Util.ajax({
        type: "POST",
        url: Oface.HOST + "/auth_demo/login",
        async: false,
        cache: false,
        dataType: "json",
        data: formData,
        beforeSend: function(xhr){            
            $('#oface-login-form #message', doc).text("Checking Username and Password.");
        },
        success: function(data, status){
            $('#oface-login-form', doc).remove();
            Oface.Controllers.Oface.main(ofaceObj);
        },
        error: function(xhr, status, error){          
            $('#oface-login-form #message', doc).text("Username or Password were incorrect. Please try again.");
            Oface.log("login ERROR with: ");
            Oface.log(xhr);
            Oface.log(status);
            Oface.log(error);
            var numRetries = parseInt( retries );
            Oface.log("retries is now", numRetries);
            if(numRetries != NaN && numRetries > 1) {
                Oface.Models.AskForLogin.authDemoLogin(doc, oface, (numRetries - 1));
            }
        }
      });
          return false;
    }
};function askForLogin(oface){
  
  var doc = Application.activeWindow.activeTab.document;
  var $ = jQuery;
  var form = Oface.Views.loginForm.toXMLString();
  $('#feed1', doc).append(form)
      .find('#login-signup-url').attr('href', Oface.HOST + "/auth_demo/create");
  
  $('#oface-login-form', doc).submit(function(){
      return Oface.Models.AskForLogin.authDemoLogin(doc, oface, 3);
  });
};

//TODO urlDb is a.... Model?
var urlDb = {};
/**
 * @param url {string} The url for the item
 * @param md5 {string} hash of the url
 * @param facets {Array of Strings} A list of Facets
 */
function updateUrlDbWithMd5AndFacets(url, md5, facets, username) {
    if( urlDb[url] ) {
      Oface.log("Already seen ", url);
    } else {
      //Oface.log("Seeing ", url, "for the first time");
      urlDb[url] = {
        md5: md5,
        facets: facets
      };
      if(username) {
        urlDb[url]['username'] = username;
      }
    }
}
var Oface = Oface || {};
Oface.Models = Oface.Models || {};

/* model
  stores data
  reads and updates
  from service
*/
Oface.Models.Facet = Oface.Models.Facet || {
        currentFacets: [],
        allFacets: [],        
        updateCurrent: function(newFacets) {
                this.currentFacets = newFacets;
                if (this.allFacets.length == 0) {
                        allFacets = newFacets.slice();                        
                } else {
                        for(var i=0; i<newFacets.length; i++){
                            if( ! this.arrayContainsByKey(newFacets[i], this.allFacets)){                               
                                this.allFacets[this.allFacets.length] = newFacets[i];                                
                            }
                        }
                }
        },
        /**
         * Adds a facet to the allFacets list
         */
        addFacet: function(json){            
            for(var i=0; i < json.length; i++){
                this.allFacets[this.allFacets.length] = json[i];
            }
        },
        updateAll: function(newFacets) {
                this.allFacets = newFacets;
        },
        arrayContainsByKey: function(needle, haystack) {
                for (var i = 0; i < haystack.length; i++) {
                        if (needle['id'] == haystack[i]['id']) {
                                return true;
                        }
                }
                return false;
        },
        /**
         * Takes a single facet and persists it
         * @param username {string} - username that we should update
         * @param facets {array} of facets
         * @param forTheWin {function} - callback when successfull. Called with json, status
         * @param fail {function} - callback when there was an error. Called with xhr, msg, exception
         */
        facetsChosen: function(username, facets, forTheWin, fail) {
                var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                Oface.log("ENCODEJSON facetsChosen", facets);
                var payload = Utils.encodeJson(facets);
                Oface.Util.ajax({
                        url: Oface.HOST + '/facets/current/' + username,
                        type: 'PUT',
                        data: payload,
                        dataType: "json",
                        success: forTheWin,
                        error: fail
                }, doc);
        },
        /**
         * Removes the facet from the user
         * @param username {string} the username
         * @param facet {array} of facets
         */
        removeUserFacet: function(username, facet) {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                Oface.Util.ajax({
                        url: Oface.HOST + '/facets/u/' + username + '/' + facet,
                        type: 'DELETE'
                }, doc);
                function notTheFacet(aFacet, index) {
                        return aFacet['description'] != facet;
                }
                this.currentFacets = $.grep(this.currentFacets, notTheFacet);
                this.allFacets = $.grep(this.allFacets, notTheFacet);                
        }
};
Oface.Views = Oface.Views || {};

/** view
 *   Mostly in HTML this is the bits of code to manipulate the view
 */
Oface.Views.Facet = Oface.Views.Facet || {
        createAll: function(username) {
          //Store a global reference to the current user
          Oface.Models.username = username;
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                var liTemplate = $('#switcher-facetlist li:first', doc).clone();
                $('#switcher-facetlist li', doc).replaceWith('');
                liTemplate.attr('class', '');
                return function(weight, facetName){
                        var li = liTemplate.clone();
                        li.addClass('weight' + weight);
                        li.find('.facetitem').text(facetName);
                        $('#switcher-facetlist', doc).append(li);
                        return li;
                };
                        
                
        },
        showAll: function() {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                var p = $('#current-facets', doc).position();
                $('#switcher', doc).css({
                        position: 'absolute',
                        'top': p.top,
                        'left': p.left
                });
                $('#switcher', doc).show();
        },
        hideAll: function(){
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                $('#switcher', doc).hide();
        },        
        createCurrent: function(){
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                var liTemplate = $('#switcher-current-facets li:first', doc).clone();
                var that = this;
                $('#switcher-current-facets li', doc).replaceWith('');
                liTemplate.attr('class', '');
                /**
                 * @param weight {number} weight from 1 to 6
                 */
                return function(weight, facetName){
                        
                        var li = liTemplate.clone();
                        li.addClass('weight' + weight);
                        li.addClass("current");
                        li.text(facetName);
                        $('#switcher-current-facets', doc).append(li);
                        //$('#switcher-current-facets', doc).append("<li>foo</li>");
                };
        },
        showCurrent: function() {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
            $('#switcher-current-facets', doc).show();
        },
        hideCurrent: function() {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
            $('#switcher-current-facets', doc).hide();
        },
        newFacetInput: function(){
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
            return  $('#switchinput', doc);     
        },
        clearInput: function(){
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
            $('#switchinput', doc).attr('value', '');      
        }
};
Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.Oface = Oface.Controllers.Facet || {
    main: function(contexty){        
        //TODO... we should check current page first
        // also we should make next step explicit? or
        // is the too much coupling?
        Oface.Timing = {};
        Oface.Timing.start = new Date();
        Oface.Models.UserDB.whoAmI(contexty, function(data, status){
            Oface.Timing.step1WhoAmI_complete = new Date();
          //TODO jQuery json ... data is a string and not an oject...why?
            
            //TODO identity is global object... belongs in the Models module?
            identity = data;
            
            if (identity.facets.length == 0 ) {
                Oface.Controllers.WelcomeNewUser.promptForFirstFacet(identity);
            } else {
                jQuery('#oface-login-form', Application.activeWindow.activeTab.document).hide();
                contexty.continueEnablingOface();    
            }            
        }, function(xhr, status, error){
          Oface.log("Origional error handler called.")
          Oface.log(xhr);
          Oface.log(xhr.status);
            if (xhr.status == 401) {
                askForLogin(contexty);
            } 
            Oface.log("whoAmI ERROR with: ");
            Oface.log(xhr);
            Oface.log(status);
            Oface.log(error);
            
        });
        
        //Register Events and their controllers
        whenWeSee('lifestream-entries-infos-available',
                  Oface.Controllers.PageFacetToggle.handleLifestreamEntriesInfosAvailable);
        whenWeSee('clustersfaceted', Oface.Controllers.EntryFacetChooser.handleClustersFaceted);
        
                //TODO register and handle 'oface-url-refaceted'        
    },
    continueWithFacets: function(data, tab){
        ofaceObj.addOfaceEnabled();
            
        triggerA('lifestream-entries-infos-available', {urlInfos: data});
        ofaceObj.updateDisplayWithFacets(data, tab, ofaceObj);
        var missed = jQuery('div.cluster', tab.document).not('.oface')
                           .addClass('unknown-entry');
        //missed.hide();
        delete Oface.running;
    }
};Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.PageFacetToggle = Oface.Controllers.PageFacetToggle || {        
        handleLifestreamEntriesInfosAvailable: function(event, params){        
            Oface.Controllers.EntryFacetChooser.handleClustersFaceted(event, params);
            
            var tab = Application.activeWindow.activeTab;            
            var data = params.urlInfos;

            var facets = [];
            var counts = [];
            for (var i=0; i< data.length; i++){
                var facet = data[i].facets[0];
                var facetIndex = facets.indexOf(facet);
                if (facetIndex == -1) {
                    facets[facets.length] = facet;
                    counts[counts.length] = 1;
                } else {
                    counts[facetIndex] += 1;
                }
            }
            //TODO: pageFacetToggler creation happens elsewhere... should happen here
            Oface.Views.pageFacetTogglerResetLabel(tab);
            for (var i=0; i< facets.length; i++){      
                var li = Oface.Views.addPageFacetTogglerAddFacet(facets[i], counts[i], tab);
                var fn = (function(){                        
                        var newFacet = facets[i];
                        return function(){Oface.Models.Facet.facetsChosen(identity.username, [newFacet], function(json, status){
                            ofaceObj.doFacetSwitch(identity.username, newFacet);
                            Oface.Controllers.PageFacetToggle.switchDisplayWithOtherFacets(newFacet, tab);
                            }, Oface.Util.noOp);};

                        })();
                li.click(fn);
            }            
            Oface.Controllers.PageFacetToggle.switchDisplayWithOtherFacets(identity['facets'][0]['description'], tab);            
    },
    switchDisplayWithOtherFacets: function(currentFacet, tab){
        /**
         * Changes the visible state of the various FacetGroups in the Lifestream
         * currentFacet string - the new facet
         */
        jQuery('#oface-other-facets li:hidden', tab.document).show();
        jQuery('#oface-other-facets li.oface-enabler-' + currentFacet + "-other", tab.document).hide();
    }
};
var $ = jQuery;
var doc = Application.activeWindow.activeTab.document;

Oface = Oface || {};
Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.EntryFacetChooser = {
    handleClustersFaceted: function(){
        jQuery('.l_more', Application.activeWindow.activeTab.document).click(Oface.Controllers.EntryFacetChooser.moarClicked);
        
        /*
        Oface.log(jQuery('.ls-entry-refacet-turnon', Application.activeWindow.activeTab.document));
        jQuery('.ls-entry-refacet-turnon', Application.activeWindow.activeTab.document).click(
            Oface.Controllers.EntryFacetChooser.handleClustersFaceted);
        
        that = Oface.Controllers.EntryFacetChooser;
        $('.entry-facet-widget-root', doc).each(function(i, el){            
            var url = $(el).data('lifestream-entry-url');            
            if(url && urlDb[url]) {
                var username = urlDb[url].username;
                if(identity.username == username) {                    
                    $(el).bind('mouseover', {controller: that}, that.mouseEnterFacetedCluster)
                         .bind('mouseout', {controller: that}, that.mouseOutFacetedCluster);
                } else {
                    Oface.log("WARNING Skipping " + username);
                }
            }
        });
        */
        return true;
        
    },
    createHandleRefacetLink: function(anEntry, anUrl) {
            return function(){
                        jQuery('.popupmenu, .popupshadow', Application.activeWindow.activeTab.document).remove();
                        Oface.Controllers.EntryFacetChooser.mouseEnterFacetedCluster(anEntry, anUrl); //580 in mobhat 3979 in ubiquity
                        return false;
                    };
    },
    moarClicked: function(){
        Oface.log("moarClicked 14");
        var entry = jQuery(this).parents('.entry');
        var url = entry.data('entry-oface-url');
        if (urlDb[url]['username'] == identity.username) {
            Oface.log('doing url=', url);
            var link = jQuery("<div class='ls-entry-facet-menu-item'><a href='#'>Refacet this entry</a></div>");
            jQuery('a', link).click(Oface.Controllers.EntryFacetChooser.createHandleRefacetLink(entry, url));
            Utils.setTimeout(
                function(){
                   jQuery('.popupmenu', Application.activeWindow.activeTab.document)
                        .append(link);
                    Oface.log($('.popupmenu'));},
                100);
            Oface.log('done with url=', url);
        }
        return true;
    },
    mouseEnterFacetedCluster: function(entry, theUrl){
        var $ = jQuery;
        Oface.log("Hello Loco", theUrl);
        if (entry === undefined || theUrl === undefined) {
            return;
        } 
        
        var urlInfo = urlDb[theUrl];
        var clusterWidget =
                  $(entry).append(<div class="cluster-facet-widget-panel">
                                    <form class="cluster-facet-widget" style="position: absolute; z-index: 666; top: -5px; right: 0px">
                                    <input type="hidden" name="md5sum" value="TODO" />
                                    <input type="hidden" name="url" value="TODO" />
                                          <select></select><button class='change' type="submit">Change</button><button class="cancel" type="reset">Cancel</button></form></div>.toXMLString());
                $options = "";
                for(var i=0; i < Oface.Models.Facet.allFacets.length; i++) {
                  var f = Oface.Models.Facet.allFacets[i];
                  var selectedVal = f['description'] === urlInfo['facets'][0] ? ' selected="true"' : '';
                  $options += "<option value='" + f['description'] + " " + f['id'] + "'" + selectedVal + ">" + f['description']  + "</option>";
                }
                $('select', entry).append($options);
                //.hide()
                $('.cluster-facet-widget', entry).bind('submit', function(){
                    var theForm = this;
                    var options = $('option[selected]', theForm);
                    var f;
                    //HACK ALERT: jQuery is acting weird here...
                    //Ubiquity jQuery returns 2 options, doing same directly in Firebug w/jQuery returns 1 option
                    //So we do some funny business here
                    options.each(function(){
                        var tmp = $(this).attr('value').split(' ');
                        if( tmp[0] != urlInfo['facets'][0]) {
                          f = tmp;
                        }
                      });
                        
                    if(f) {
                        $('select, button.change', theForm).attr('disabled', true);
                        $('select', $('.cluster-facet-widget')).attr('disabled', true)
                        var newFacets = {id: f[1], description: f[0]};
                        //TODO why is this encoded as a list?
                        var newResource = [{facets: newFacets, urlInfo: urlInfo, url: theUrl}];
                        Oface.log("ENCODEJSON mouseEnterFacetedCluster", newResource);
                        var payload = Utils.encodeJson(newResource);
                        //TODO it's possible that the user fails login hre...
                        Oface.Util.ajax({
                          url: Oface.HOST + '/resources/resource/' + urlInfo['md5'] + '/user/' + Oface.Models.username,
                          type: 'PUT',
                          data: payload,
                          dataType: 'json',
                          success: function(jsn, status){
                            //
                              Oface.log("Testing me out11, replacing", urlDb[theUrl]);
                              urlDb[theUrl]['facets'] = [f[0]];
                              Oface.log("With", urlDb[theUrl]);
                              $(theForm).trigger('oface-url-refaceted',{
                                  entry: entry,
                                  url: theUrl,
                                  oldFacets: urlInfo['facets'],
                                  newFacets: newFacets
                                });
                        //TODO remove?
                          $(theForm).hide();
                          },
                          cache: false
                        });
                    } 
                    return false;
                });
                $('.cancel', entry).click(function(){
                    //TODO remove?
                    $('.cluster-facet-widget', entry).hide();
                    return false;
                });
                /*$('.cluster-facet-widget-link', entry).show().click(function(){
                    $('.cluster-facet-widget', entry).show();
                    return false;
                  });*/
              //jQuery(entry).data('oface.faceted.cluster.widget', clusterWidget);
            /*} else {
              var clusterWidget = jQuery(cluster).data('oface.faceted.cluster.widget');
              //TODO
              Oface.log("TODO show this form again sldkfjsdkjewrj");
            }*/
            //$('.cluster-facet-widget-link', cluster).show();
            //clear Timeout if exists
            /*if ( $(cluster).data('oface.faceted.cluster.widget.timer') ) {              
              Utils.clearTimeout($(cluster).data('oface.faceted.cluster.widget.timer'));
              $(cluster).data('oface.faceted.cluster.widget.timer', null)
            } */
        },
        mouseOutFacetedCluster: function(event){
          var $ = jQuery, cluster = event.target;
          /*
            var c = $(cluster);
              while( c.length && ! c.hasClass('summary')){      
                  c = c.parent();
              }
            cluster = c.get(0);
          */
          if ( ! $(cluster).data('oface.faceted.cluster.widget.timer') ) {
            var timer = Utils.setTimeout(function(){
                  $('.cluster-facet-widget-link', cluster).hide();  
              }, 1000);
              $(cluster).data('oface.faceted.cluster.widget.timer', timer);              
              
          }
        }
};;var $ = jQuery;
var doc = Application.activeWindow.activeTab.document;

Oface = Oface || {};
Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.FacetGroups = {
    t: null,
    prepareLabel: function(prevFacet, currentFacet, prevItemCount, cluster) {
        
        if(prevFacet != currentFacet){          
          if(this.t) jQuery('span.count', this.t).text(prevItemCount);
          prevItemCount = 0;
          //TODO change the text 1 below to x and see if this code is buggy
          //I think it is structured wrong and prepareLabel should be called
          //again once after outter for loop finishes...
          this.t = jQuery("<h4 class='group-facet " + currentFacet +
                     "' style='clear:left'><span class='facet-name'>" + (currentFacet) + "</span>" + 
                     " <span class='count'>1</span></h4> ", doc);
          this.t.css({
             'class': 'toggler',
             'height': '15px',
            'float' : 'left',
            'margin-right': '10px'
          });
          cluster.before(this.t);
          
          var facetGroupLabelFn = (function(){
              var facet = currentFacet;
               return function(){
                    
                    Oface.Models.Facet.facetsChosen(identity.username, [facet], function(json, status){
                        ofaceObj.doFacetSwitch(identity.username, facet);
                        }, Oface.Util.noOp);
              };
          })();
          this.t.click(facetGroupLabelFn);          
          
        }
    }
};;Oface = Oface || {};
Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.WelcomeNewUser = {
    promptForFirstFacet: function(identity) {
        var $ = jQuery, doc = Application.activeWindow.activeTab.document;
        $('#feed1', doc).append(Oface.Views.welcomeNewUser)
            .find('form').bind('submit', {identity: identity}, Oface.Controllers.WelcomeNewUser.handleSubmit);
        $('#new-user-name', doc).text(identity.username);
    },
    handleSubmit: function(event) {
        var identity = event.data.identity;
        var $ = jQuery, doc = Application.activeWindow.activeTab.document;
        var newFacet = $('#facetinput', this).attr('value');
        Oface.Models.Facet.facetsChosen(identity.username, [newFacet],
            function(json, status){
                Oface.log("Restarting with new facets");
                $('#welcome-new-user-panel', doc).remove();
                Oface.Controllers.Oface.main(ofaceObj);
            }, Oface.Util.noOp);
        return false;
    }
};
Oface.Controllers = Oface.Controllers || {};
Oface.Controllers.Facet = Oface.Controllers.Facet || {
        username: "Unknown",
        initialize: function(){
                
                var that = this;
                var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                $('head', doc).append('<link rel="stylesheet" href="' + Oface.HOST + '/static/css/stylo.css" type="text/css" media="screen" />');
                var switcherXml = <div id="switcher" style='position:absolute; z-index: 2; width: 600px; display: none; background-color: #CCC;'>
						<div id="all-facets">
								<h4>All Facets</h4>

								<ul id='switcher-facetlist' style="list-style-type: none;">                                
										<li style="float: left; margin-right: 5px"><span class="facetitem"></span> <a href="#" class="remove-facet-a">x</a></li>
								</ul>
                          <div style="clear:left">
						    <label for="switchinput">Add A New Facet:</label> <input id="switchinput" value="" />
						    <button id="all-facets-save">Save</button>
                            <button id="all-facets-close">Close</button>
                          </div>
						</div>				        
				</div>.toXMLString();
                $('#oface-enabler', doc).after(switcherXml);
                //TODO is this duplicated between orig oface and the switcher?
                Oface.Timing.step4CurrentFacets_start = new Date();
                Oface.Util.ajax({
                        url: Oface.HOST + '/facets/current/' + this.username,
                        type: "GET",
                        beforeSend: function(xhr) {
                            var switcher = $('#switcher', doc);
                            var w = switcher.width();
                            var h = switcher.height();
                            var offset = switcher.offset();
                            Oface.Views.Facet.hideAll();
                            $('#oface-enabler', doc).after(
                                '<div id="switcher-progress-panel"><img src="http://mobhat.restservice.org/static/images/ubiquity/progress-icon.gif" /></div>');
                            var p = $('#switcher-progress-panel', doc).width(w).height(h).offset(offset);
                        },
                        complete: function(){$('#switcher-progress-panel', doc).remove(); },
                        success: function(json) {
                            Oface.Timing.step4CurrentFacets_complete = new Date();
                            Oface.log("Finishing with X");
                            Oface.Models.Facet.updateCurrent(json);
                        
                            //TODO using call here isn't necissary
                            var curFacetView = Oface.Views.Facet.createCurrent.call(Oface.Views.Facet);
                        
                            var currentFacets = Oface.Models.Facet.currentFacets;
                            for (var i = 0; i < currentFacets.length; i++) {
                                    curFacetView(currentFacets[i]['weight'],
                                         currentFacets[i]['description']);                               
                            }
                            $('#switcher-current-facets li', doc).click(Oface.Views.Facet.showAll);
                            Oface.Views.Facet.showCurrent();                        
                        },
                        dataType: "json"});
                Oface.Timing.step5AllFacets_start = new Date();
                Oface.Util.ajax({
                        url: Oface.HOST + '/facets/weighted/' + that.username,
                        type: "GET",
                        success: function(json) {
                                Oface.log("Finishing with Y");
                                Oface.Timing.step5AllFacets_complete = new Date();
                                Oface.Models.Facet.updateAll(json);
                                that.updateAllView();
                        },
                        dataType: "json"});
                var contextx = {username: Oface.Controllers.Facet.username};
                /* add behaviors */
                Oface.Views.Facet.newFacetInput().bind('blur', contextx, Oface.Controllers.Facet.handleNewFacetCreated);
                $('#all-facets-close', doc).bind('click', contextx, Oface.Controllers.Facet.allFacetsCloseHandler);
        },
        updateAllView: function(){
                var that = this;
                                var currentFacets = Oface.Models.Facet.currentFacets;
                                var allFacets = Oface.Models.Facet.allFacets;

                                var view = Oface.Views.Facet.createAll(that.username);
                                for (var i = 0; i < allFacets.length; i++) {
                                    var f = view(allFacets[i]['weight'],
                                                 allFacets[i]['description']);
                                        f.bind('click',
                                                {username: Oface.Controllers.Facet.username,
                                                description: allFacets[i]['description']}, Oface.Controllers.Facet.handleOtherFacetChosen);
                                    if (Oface.Models.Facet.arrayContainsByKey(allFacets[i], currentFacets)) {
                                        f.addClass("current").find('.remove-facet-a').hide();
                                    } else {
                                        f.find('.remove-facet-a').show();
                                    }
                                    f.find('.remove-facet-a').bind('click', {
                                            facet: allFacets[i]['description']
                                        },
                                        function(event) {                                            
                                            Oface.Models.Facet.removeUserFacet(that.username, event.data.facet);
                                            //Oface.Views.Facet.showCurrent();
                                            //Oface.Views.Facet.createAll(Oface.Controllers.Facet.username);
                                            that.updateAllView();
                                            Oface.Views.Facet.showAll();
                                            return false;
                                        });
                                }      
        },
        chooseNewFacetCallback: function(json, status){                
                Oface.Models.Facet.addFacet.call(Oface.Models.Facet, json);
                this.updateAllView();
                this.chooseFacetCallback(json, status);
        },
        chooseFacetCallback: function(json, status) {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                Oface.log("chooseFacet called");
                //AOK
                Oface.Models.Facet.updateCurrent(json);
                
                var curFacetView = Oface.Views.Facet.createCurrent.call(Oface.Views.Facet);
                
                var currentFacets = Oface.Models.Facet.currentFacets;                        
                        for (var i = 0; i < currentFacets.length; i++) {
                                curFacetView(currentFacets[i]['weight'],
                                             currentFacets[i]['description']);                               
                        }
                        
                $('#switcher-current-facets li', doc).click(Oface.Views.Facet.showAll);
                Oface.Views.Facet.showCurrent();
                
                Oface.Views.Facet.hideAll();
        },
        handleOtherFacetChosen: function(event) {
                that = this;
                var data = event.data;
                Oface.Models.Facet.facetsChosen(Oface.Controllers.Facet.username, [data['description']],
                    function(json, status){                        
                        Oface.Controllers.Facet.chooseFacetCallback(json, status);
                    }, Oface.Util.noOp);
                ofaceObj.doFacetSwitch(Oface.Controllers.Facet.username, data['description']);
        },
        /**
         * handleNewFacetCreated is called only with potentially new facets
         */
        handleNewFacetCreated: function(event) {
          var $ = jQuery, doc = Application.activeWindow.activeTab.document;
                Oface.Models.Facet.facetsChosen(event.data.username, $('#switchinput', doc).attr('value').split(','), function(json, status){
                    Oface.Controllers.Facet.chooseNewFacetCallback.call(Oface.Controllers.Facet, json, status);
                    //Oface.Controllers.Facet.chooseNewFacetCallback(json, status);
                }, Oface.Util.noOp);
                ofaceObj.doFacetSwitch(Oface.Controllers.Facet.username, ($('#switchinput', doc).attr('value').split(','))[0]);
                Oface.Views.Facet.clearInput();
                
        },
        allFacetsCloseHandler: function() {
                Oface.Views.Facet.hideAll();
        }
} // END Oface.Controllers.Facet


var divId = 'feed1';
var oFaceIsEnabled = true;
var lastSeenFacetHeadings = null;
var lastHiddenItems = null;
var lastHiddenSubItems = null;
var unknownItems = null;
function ofaceToggler(){
  
  var $ = jQuery;
  var doc = Application.activeWindow.activeTab.document;
  if (unknownItems === null) {
    unknownItems = jQuery('.unknown-entry', doc);
    Oface.log("Looking for unknownitems", unknownItems);
  } else {
    Oface.log("Looking for unknownitems - already good");
  }
  if(oFaceIsEnabled){
    $('h3#oface-enabler span.status', doc).text("Disabled");    
    //TODO show/hide is broken here... why?
    $('.current-facet', doc).hide();
    $('#oface-other-facets', doc).hide();
    lastSeenFacetHeadings = $('h4.group-facet:visible', doc).hide();
    lastHiddenSubItems = $('.entry:hidden',doc);
    lastHiddenItems = $('div.oface:hidden', doc).show();
    //TODO rename class oface to oface-cluster and add a new one oface-entry
    $('.oface:hidden').show();
    lastHiddenSubItems.show();
    jQuery('div.cluster', doc).not('.oface').show();
    jQuery('.current-facet', doc).show();
    oFaceIsEnabled = false;
    unknownItems.removeClass("unknown-entry");
    Oface.log("Removing");
  }else{
    $('h3#oface-enabler span.status', doc).text("Enabled");
    $('.current-facet', doc).show();
    $('#oface-other-facets', doc).show();
    lastSeenFacetHeadings.show();
    lastHiddenItems.hide();
    lastHiddenSubItems.hide();
    //jQuery('div.cluster', doc).not('.oface').hide();
    oFaceIsEnabled = true;
    unknownItems.addClass("unknown-entry");
  }
}



;var ofaceObj = {
  name: "fetch-feed-oface",
  env: "http://friendfeed.com",
  testenv: "http://oface.ubuntu/static/test_files/",
  envFor: function(url){
    Oface.log(url);
    if (/.*oface\.ubuntu.*/.test(url)){
      return this.testenv;
    } else {
      return this.env;
    }
  },
  preview: function(pblock, input){
    /**
     * Either via Ubiquity command or pageLoad preview is our first stop...
     */
    //TODO get ride of this - context object
    
    if ( Oface.running === undefined || (new Date() - Oface.running) > 3000 ) {
        Oface.running = new Date();
        //Oface.log("Starting oface");
        CmdUtils.log("Starting oface");
        Oface.Controllers.Oface.main(this);
    } else {
        Oface.log("Skipping oface, instance already running");
    }
  },
  continueEnablingOface: function(){
      /**
       * TODO this method belongs on OFace.main controller
       */
        var tab = Application.activeWindow.activeTab;    
    var url = this.envFor(tab.document.location.href) + jQuery('link[type=application/atom+xml]', tab.document).attr('href');
    var that = this;
    
    page = Oface.WhatPageIsThis.really.call(Oface.WhatPageIsThis);
    if (! page.isKnown) {
      Oface.log("Unknown page type... Skipping");
    } else {      
      if ( ! Oface.WhatPageIsThis.isSupportedPage(page.type)){
        Oface.log("Page type " + page.type + " Skipping");
      } else {
        var sucessFn;
        var username;
        Oface.log("I think I am on a " + page.type + " page");
        if( page.type == Oface.WhatPageIsThis.PROFILE_PAGE ) {
          username = Oface.WhatPageIsThis.getUsername.call(Oface.WhatPageIsThis, page.url, page.type);
          successFn = function(data, status){
            Oface.Timing.step2complete = new Date();
            Oface.log("atom feed XHR call status " + status);
            Oface.log(data);
            var urls = that.processFeedForUrls(data.documentElement, tab, that);
            
            Oface.log('in preview calling that.getFacetsForUser');
            that.getFacetsForUser(that, tab, username, urls, false);          
          };          
        } else {
          // Home, or other mixed username page... not in the url
          username = identity.username;
          successFn = function(data, status){
            Oface.Timing.step2complete = new Date();
            Oface.log("atom feed XHR call status " + status);
            
            var urls = that.processFeedForUrls(data.documentElement, tab, that, true);
            var validItems = [];
            //TODO validate url, published, etc
            for (var i=0; i<urls.length; i++) {
              if ( urls[i]['username']) {
                validItems.push(urls[i]);
              }
            }
            Oface.log(validItems);
            that.getFacetsForManyUsers(that, tab, validItems);          
          };   
        }
        Oface.Timing.step2_start = new Date();
        var h = this.fetchFeed(that, tab, username, url, successFn);
        Oface.Util.ajax(h, tab);
        
      }
    }
  },
  fetchFeed: function(that, tab, username, url, successFn){
    return {
        url: url,
        success: successFn,
        error: function(xhr, status, err){
          Oface.log("Ouch trouble fetching the feed " + url);
          Oface.log(xhr);
          Oface.log("XHR call status " + status + " responseText=" + xhr.responseText);
          Oface.log(err);
        }
      };
  },
  /**
   * @param username {string} optional - if username is given, then item will
   *  not each individually
   */
  processFeedForUrls: function(feed, tab, that, isEachWithUsername){
    var $ = jQuery;
    isEachWithUsername = isEachWithUsername || false;
    
    var entries = jQuery('entry', feed);
    var urls = [];
    entries.each(function(i){
      var url = jQuery('link', this).attr('href');
      var time = jQuery('published', this).text();
      var item = {url: escape(url),
                   md5sum: that.md5(url),
                   published: jQuery('published', this).text()};
      if (isEachWithUsername) {
        try{
          //TODO brittle          
          var selector = that.linkSelector(url, tab);
          
          var entry = $(selector, tab.document);
          if (entry.length == 0) {
              logError("processFeedForUrls's selector " + selector + " failed to match any entries", [url]);
          } else {
              var cluster = entry;
              while( cluster.length && ! cluster.hasClass('cluster')){      
                  cluster = cluster.parent();
              }
              if(cluster.length > 0){
                 //update this div...
                  var userHref = $('div.summary a.l_person', cluster).attr('href');                  
                  if ( userHref ) {
                      var pieces = userHref.split('/');
                      // http://friendfeed.com/draarong
                      item['username'] = pieces[pieces.length -1];                      
                  } else {
                     Oface.log("WARNING can't find username for " + url);
                 }
              }else{
                  logError("processFeedForUrls's bubbling up from entry, can't find outter cluster", [entry, cluster]);
              } 
          }
        } catch (error) {
          Oface.log(error);
        }
      }
      urls.push( item);
      });
    return urls;
  },
  logTiming: function(){
    Oface.log("xLogging timing back to home");
          Oface.Timing.step3queryFacets_complete = new Date();
          
          var timingUrl = Oface.HOST + '/static/images/timing.gif?s1=' + Oface.Timing.start.getTime() +
            '&s1c=' + Oface.Timing.step1WhoAmI_complete.getTime() +
            '&s2s=' + Oface.Timing.step2_start.getTime() +
            '&s2c=' + Oface.Timing.step2complete.getTime();
            
            timingUrl += '&s3s=' + Oface.Timing.step3queryFacets_start.getTime() +
            '&s3c=' + Oface.Timing.step3queryFacets_complete.getTime();
          Oface.log("Looking for " + timingUrl);
          jQuery.get(timingUrl);
  },
  getFacetsForUser: function(that, tab, aUsername, urls){
    /* urls [{id: 'md5sum', url: 'url', published: '2009-01-28T06:00:29Z'},] */
    var query = { urls: urls };
    Oface.log("ENCODEJSON getFacetsForUser", query);
    var dataPayload = "q=" + Utils.encodeJson(query);
    Oface.log("Finished Using Utils.encodeJson");
    Oface.log("preparing continueWithFacets");
    
    var h = {
      url: Oface.HOST + '/resources/user/' + aUsername + '/query_facets',
      type: 'POST',
      dataType: 'json',
      cache: false, // REMOVE FOR PROD
      data: dataPayload,
      success: function(jsn, status){
          that.logTiming();
          var data = [];
          for(var i=0; i<jsn.length; i++){
              //TODO we are throwing away id, created date
              data[i] = {
                facets: [jsn[i]['facets'][0]['description']],
                url: unescape(jsn[i]['url']),
                username: aUsername
                };                        
          }
          Oface.Controllers.Oface.continueWithFacets(data, tab);     
      },
      error: function(xhr, status, err){
        Oface.log("status=", status);
        Oface.log("err=", err);
          if(parseInt(xhr.status) == 404) {
              Oface.log("User", aUsername, "is not an OFace user");
              Oface.Controllers.Oface.continueWithFacets([], tab);
          } else {
              Oface.log("Ouch trouble fetching facet info for urls during getFacetsForUser ");
              Oface.log(xhr);          
              Oface.log("XHR call status " + status + " responseText=" + xhr.responseText);          
              Oface.log(err);  
          }
      }
  };
   
    Oface.Timing.step3queryFacets_start = new Date();
    Oface.Util.ajax(h, tab.document);
    /*
    //after async
    var data = urls.slice(0);
    var facets = [["w
    "],["art"],["family"]];
    for(var i = 0; i < data.length; i++){
      if(i == 0 || i == 6){
        data[i].facets = facets[0];
      } else if(i == 1 || i == 5 ){
        data[i].facets = facets[2];
      } else if(i >= 2 && i < 5 ){
        data[i].facets = facets[1];
      } else {
        data[i].facets = facets[Math.round(Math.random() * 2)];
      }
    }
    */
    
               
  },
  getFacetsForManyUsers: function(that, tab, urls){
    /* urls [{username: 'pattyok', id: 'md5sum', url: 'url', published: '2009-01-28T06:00:29Z'},] */
    Oface.log('getFacetsForManyUsers');
    Oface.Timing.step3queryFacets_start = new Date();
    Oface.Models.ResourceDB.queryFacets(urls, 
       function(jsn, status){
          Oface.log("got results for getFacetsForManyUsers");
          that.logTiming();
          if(status == 'success'){
            
            var data = [];
            for(var i=0; i<jsn.length; i++){
              try{
                if (jsn[i]['facets']) {
                  //TODO we are throwing away id and create data, etc
                  data.push({
                    facets: [jsn[i]['facets'][0]['description']],
                    url: unescape(jsn[i]['url']),
                    username: jsn[i]['username']
                  });
                }
              } catch(error){
                Oface.log(error);
              }
            }
            //TODO this could happen earlier? Why here?
            Oface.Controllers.Oface.continueWithFacets(data, tab);
          }
      }, function(xhr, status, err){
          Oface.log("Ouch trouble fetching facet info for urls during getFacetsForManyUsers ");
          Oface.log(xhr);
          Oface.log("XHR call status " + status + " responseText=" + xhr.responseText);
          Oface.log(err);
      });
  },
  linkSelector: function(link, tab){
    var selector = 'div.title a[href=' + link + ']';
      if(link.indexOf('twitter') >= 0){
        selector = 'div[viewinlink=' + link + ']';
      }else if(link.indexOf('friendfeed.com/e/') >= 0){        
        // http://friendfeed.com/e/fdb550f2-869e-4a1c-b4ce-11d2d9d4d282  
        // is not present in the html... it is dynamically added to the
        // More menu item as 'Link to this entry'
        var eid = /^http.?:\/\/.*friendfeed\.com\/e\/(.*)$/.exec(link)[1];
        selector = 'div[eid=' + eid + ']';
        
      }else if(link.indexOf('flickr.com/') >= 0 &&
               jQuery(selector, tab.document).length != 1){
        // flickr is either in the default format or this
        // format when several are collapsed together...
        selector = 'div.container a[href=' + link + ']';
      } else if(link.indexOf('feedproxy.google.com/') >= 0){
        //a[href=http://feedproxy.google.com/~r/slashfilm/~3/vjoxle-72JM/] becomes
        //a[href=http://feedproxy.google.com/%7Er/slashfilm/%7E3/vjoxle-72JM/]
        selector = selector.replace(/~/g, "%7E");
      }
      return selector;
  },
  updateDisplayWithFacets: function(data, tab, that){
    var prevFacet = "";
    var prevItemCount = 0;
    //[Oface.log(i + " " + data[i].facets[0] + " " + data[i].url) for (i in data)];
    //Oface.log(data);
    for(var i=0; i < data.length; i++){
      /* Grab an item by url (this varies by webapp)
      *  bubble up the DOM until you reach the FriendFeed container */
      //Oface.log(i);
      //Oface.log(data[i]);
      if ( ! data[i] | !data[i].url ) {
        Oface.log("ERROR data[i] is null or something is wrong, skipping", data[i]);
        continue;
      }
      
      updateUrlDbWithMd5AndFacets(data[i].url, that.md5(data[i].url), data[i].facets, data[i].username);
      var selector = that.linkSelector(data[i].url, tab);
      Oface.log("the selector=" + selector);
      var a = jQuery(selector, tab.document);
      if(a.length >= 1){
        var success;
        var entry;
        var cluster;
        
        [success, entry  ] = that.findAndTagByClass(a,'entry', data[i].facets);
        Oface.log("updateDisplayWithFacets entry",success, entry);
        if( success ){
          entry.data('lifestream-entry-url', data[i].url);
          entry.addClass('entry-facet-widget-root');
          entry.data('entry-oface-url', data[i].url);
        } else {
          //Flickr uses tr as it's container...
          Oface.log("WARNING, might not have found an entry div for anchor tag " + data[i].url);
        }
        [success, cluster] = that.findAndTagByClass(a,'cluster', data[i].facets);
        Oface.log("updateDisplayWithFacets cluster " + " " + success + " " + cluster);
        if(! success ){
          Oface.log("ERROR, expected to find a cluster div for anchor tag " + data[i].url);
        }
        if(! cluster.hasClass('oface')){
          cluster.addClass('oface');
        }
        Oface.Controllers.FacetGroups.prepareLabel(prevFacet, data[i].facets[0], prevItemCount, cluster);
        prevFacet = data[i].facets[0];
        prevItemCount++;
      }
      if(a.length != 1){
        //href=http://www.flickr.com/photos/wigfur/3229310456/
        //Oface.log("Looking for 'div.title a[href=" + data[i].url + "]' but found " + a.length + " items");
        //TODO send a report back to home base???
        
      } //if(a.length == 1){
    } // for(var i=0; i < data.length; i++){
    ofaceObj.doFacetSwitch(identity.username, identity.facets[0]['description']);
    jQuery('div.cluster, div.pager', tab.document).css('clear', 'left');
    Oface.log('Triggering clustersfaceted');
    jQuery(tab.document).trigger('clustersfaceted');
  },
  findAndTag: function(element, containerClassName, facets, matchFn){
        var cluster = element;
        while( cluster.length && ! matchFn(cluster)){      
          cluster = cluster.parent();
        }
        if(cluster.length > 0){
          //update this div...
          var c = "oface-" + facets[0] + "-facet";
          if(! cluster.hasClass(c)){            
            cluster.addClass(c);
          }        
          return [true, cluster];
        }else{
          return [false, element];
        }
  },
  findAndTagByClass: function(element, containerClassName, facets){
    return this.findAndTag(element, containerClassName, facets, function(cluster){
      return cluster.hasClass(containerClassName);
      });    
  },
  doFacetSwitch: function(username, facet){
    /**
     * TODO replace this with an event, pull code below out into a model db
     * username string the username
     * facet string a facet description
     */
    Oface.log('Switching Current Facet in Display');
    var doc = Application.activeWindow.activeTab.document;
    jQuery('h4.group-facet', doc).show();
    jQuery('h4.group-facet.' + facet, doc).hide('slow');
    
    //TODO Bug off by 1 error? cluster vs entry?
    var itemCount = jQuery('.entry.oface-' + facet + '-facet', doc).length;
    Oface.log("Switching to a facet with " + itemCount);
    
    jQuery('div.current-facet div', doc).text(facet + " (" + itemCount + ")");
    
    jQuery('#oface-enabler span.current-facet-count', doc).text(itemCount);
    
    jQuery('div.entry.oface-' + facet + '-facet:hidden, div.cluster.oface-' + facet + '-facet', doc).show('slow');    
    jQuery('div.cluster.oface', doc).not('.oface-' + facet + '-facet').hide('slow');
    
    Oface.Controllers.PageFacetToggle.switchDisplayWithOtherFacets(facet, Application.activeWindow.activeTab);
  },  
  md5: function(str){
    // https://developer.mozilla.org/en/nsICryptoHash
    var converter =
      Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].
        createInstance(Components.interfaces.nsIScriptableUnicodeConverter);

    // we use UTF-8 here, you can choose other encodings.
    converter.charset = "UTF-8";
    // result is an out parameter,
    // result.value will contain the array length
    var result = {};
    // data is an array of bytes
    var data = converter.convertToByteArray(str, result);
    var ch = Components.classes["@mozilla.org/security/hash;1"]
                       .createInstance(Components.interfaces.nsICryptoHash);
    ch.init(ch.MD5); //MD5 SHA1
    ch.update(data, data.length);
    var hash = ch.finish(false);

    // return the two-digit hexadecimal code for a byte
    function toHexString(charCode)
    {
      return ("0" + charCode.toString(16)).slice(-2);
    }

    // convert the binary hash data to a hex string.
    return [toHexString(hash.charCodeAt(i)) for (i in hash)].join("");
  },
  addOfaceEnabled: function(){
    /**
     * TODO this is a controller method...
     */
    var $ = jQuery;
    var doc = Application.activeWindow.activeTab.document;
    if( $('#' + divId + ' h3#oface-enabler', doc).length == 0){
      Oface.log("Adding widget");
       $('#feed1', doc).prepend($(Oface.Views.pageFacetToggler.toXMLString(), doc));

      var ofaceEnabler = $(Oface.Views.userFacetToggler.toXMLString(), doc);
      
      $('#feed1', doc).prepend(ofaceEnabler);      
      $('.current-facet div:first', doc).text(identity.facets[0]['description']);
      
      $('#oface-enabler', doc).click(ofaceToggler);
      $('.current-facet', doc).click(function(){
          $('#switcher', doc).toggle();
      });
      
      
                        
      //TODO AOK
      Oface.Controllers.Facet.username = identity.username;
      Oface.Controllers.Facet.initialize.call(Oface.Controllers.Facet);
      $('h3#oface-enabler span.current-facet', doc).css('margin-left', '30px');
      Oface.log("Finishing with addOfaceEnabed");
    }else{
      Oface.log('Already have the widget');    
    }
  }
};
/**
 * You can use fetch- command  during development (comment out pageLoad_fetchFeedOface )
 * or uncomment pageLoad_fetchFeedOface for auto load

function pageLoad_fetchFeedOface(){
    CmdUtils.log("Starting ");
    ofaceObj.preview.call(ofaceObj);
}
  */

;(function(){
CmdUtils.CreateCommand(ofaceObj);
})();//Growl displayMessage
//Replace selected text CmdUtils.setSelection("You selected: "+input.html);
//Application - FUEL Application - http://developer.mozilla.org/en/docs/FUEL 
/* This is a template command */
CmdUtils.CreateCommand({
  feedIcon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJDSURBVHjajJJNSBRhGMd/887MzrQxRSLbFuYhoUhEKsMo8paHUKFLdBDrUIdunvq4RdClOq8Hb0FBSAVCUhFR1CGD/MrIJYqs1kLUXd382N356plZFOrUO/MMz/vO83+e93n+f+1zF+kQBoOQNLBJg0CTj7z/rvWjGbEOIwKp9O7WkhtQc/wMWrlIkP8Kc1lMS8eyFHpkpo5SgWCCVO7Z5JARhuz1Qg29fh87u6/9VWL1/SPc4Qy6n8c0FehiXin6dcCQaylDMhqGz8ydS2hKkmxNkWxowWnuBLHK6G2C8X6UJkBlxUmNqLYyNbzF74QLDrgFgh9LLE0NsPKxjW1Hz2EdPIubsOFdH2HgbwAlC4S19dT13o+3pS+vcSfvUcq9YnbwA6muW9hNpym/FWBxfh0CZkKGkPBZeJFhcWQAu6EN52QGZ/8prEKW+cdXq0039UiLXhUYzdjebOJQQI30UXp6mZn+Dtam32Afu0iyrgUvN0r+ZQbr8HncSpUVJfwRhBWC0hyGV8CxXBL5SWYf9sYBidYLIG2V87/ifVjTWAX6AlxeK2C0X8e58hOr/Qa2XJ3iLMWxB1h72tHs7bgryzHAN2o2gJorTrLxRHVazd0o4TXiyV2Yjs90uzauGvvppmqcLjwmbZ3V7BO2HOrBnbgrQRqWUgTZ5+Snx4WeKfzCCrmb3axODKNH+vvUyWjqyK4DiKQ0eXSpFsgVvLJQWpH+xSpr4otg/HI0TR/t97cxTUS+QxIMRTLi/9ZYJPI/AgwAoc3W7ZrqR2IAAAAASUVORK5CYII%3D",
  name: "discover-feeds-oface",
  icon: this.feedIcon,
  homepage: "http://ozten.com/",
  author: {
    name: "Your Name",
    email: "you@example.com"
  },
  license: "GPL",
  description: "Lists Feeds that this page contains",
  help: "how to use your command",
  preview: function(pblock, input) {
    //var d = context.chromeWindow.window.document;
    var d = CmdUtils.getDocument();
    var links = d.getElementsByTagName('link');
    var template = "<h4>Feeds</h4>";
    var data = {};
    var type = {
      'application/rss+xml': 'RSS',
      "application/atom+xml": "Atom"
    };
    var numFeeds = 0;
    template += "<ul>";
    for (var i = 0; i < links.length; i++) {
      var link = links[i];
      var title = links[i].title || "Untitled Feed";
      
      if (link.type == "application/atom+xml" || link.type == "application/rss+xml") {
        numFeeds += 1;
        template += "<li ><img src='" + this.feedIcon + "' /> " + " <a href='" + link.href + "'>" + title + "</a> <small>(" + type[links[i].type]  + ")</small></li>";
        //Oface.log(links[i].title + " " + links[i].href);
      }
      template += "</ul>";

    }
    if (numFeeds == 0) {
      template = "None Feeds discovered";
    }
    pblock.innerHTML = CmdUtils.renderTemplate(template, data);
    var doc = Application.activeWindow.activeTab.document;
    jQuery('div.cluster', doc).css('border', 'solid 1px grey');
  }
});
//Short term FriendFeed Specific stuff
//Important for proof of concept, not how real service would work
Oface.WhatPageIsThis = {
  name: "what-page-is-this-oface",
  preview: function(pblock, input){
    var doc = Application.activeWindow.activeTab.document;
    pblock.innerHTML = "Supported? <b>" + this.isSupportedPage(this.pageType(doc.location.href)) +
      "</b> type=<b>" + this.pageType(doc.location.href) + "</b>";
  },
  really: function(){
    /**
     * @returns {array} A two item array, [true/false, pageType]
     * pageType - One of the _PAGE constants from this object like PROFILE_PAGE
    */
    var doc = Application.activeWindow.activeTab.document;
    var url = doc.location.href;
    
    if (url.indexOf("http://oface.ubuntu/static/test_files/ff-pattyok.html") >= 0) {
      Oface.log('Replacing ' + url + " with hardcoded http://friendfeed.com/pattyok");
      url = "http://friendfeed.com/pattyok";
    } else if(url.indexOf("http://oface.ubuntu/static/test_files/ozten_home.html") >=0) {
      Oface.log('Replacing ' + url + " with hardcoded http://friendfeed.com/");
      url = "http://friendfeed.com/";
    }
    var aPageType = this.pageType(url);
    return {isKnown:  this.isSupportedPage(aPageType),
            type: aPageType,
            url: url};
  },
  HOME_PAGE: "home",            HOME_REGEX:     /^https?:\/\/w?w?w?\.?friendfeed\.com\/$/,
  PROFILE_PAGE: "profile",      PROFILE_REGEX:  /^https?:\/\/w?w?w?\.?friendfeed\.com\/(\w+)(#.*)?(\?start.*)?$/,
  LIST_PAGE: "list",            LIST_REGEX:     /^https?:\/\/w?w?w?\.?friendfeed\.com\/list\/(\w+)$/,
  ROOMS_LIST_PAGE: "roomslist", ROOMS_LIST_REGEX: /^https?:\/\/w?w?w?\.?friendfeed\.com\/rooms\/?$/,
  ROOM_PAGE: "room",            ROOM_REGEX:     /^https?:\/\/w?w?w?\.?friendfeed\.com\/rooms\/(\w+)$/,
  EVERYONE_PAGE: "everyone",    EVERYONE_REGEX: /^https?:\/\/w?w?w?\.?friendfeed\.com\/public$/,
  //A User's Profile plus their friends
  FRIENDS_PAGE: "profilewfriends", FRIENDS_REGEX: /^https?:\/\/w?w?w?\.?friendfeed\.com\/(\w+)\/friends$/,
  UNKNOWN_PAGE: "unknown",
  pageType: function(url){    
    if(       this.HOME_REGEX.test(url)){
      return  this.HOME_PAGE;
    } else if(this.LIST_REGEX.test(url)) {
      return  this.LIST_PAGE;
    } else if(this.ROOMS_LIST_REGEX.test(url)) {
      return  this.ROOMS_LIST_PAGE;
    } else if(this.ROOM_REGEX.test(url)) {
      return  this.ROOM_PAGE;
    } else if(this.EVERYONE_REGEX.test(url)) {
      return  this.EVERYONE_PAGE;
    } else if(this.FRIENDS_REGEX.test(url)){
      return  this.FRIENDS_PAGE;
    } else if(this.PROFILE_REGEX.test(url)){
      return  this.PROFILE_PAGE;
    } else {
      return this.UNKNOWN_PAGE;
    }
    
    //Known unknowns
    // Linkable Urls
    // USER_COMMENTS_PAGE /^https?:\/\/w?w?w?\.?friendfeed\.com\/(\w+)\/comments$/
    // USER_LIKES_PAGE   /^https?:\/\/w?w?w?\.?friendfeed\.com\/(\w+)\/likes$/
    // USER_DISCUSSION /^https?:\/\/w?w?w?\.?friendfeed\.com\/(\w+)\/discussion$/
    // SEARCH http://friendfeed.com/search?required=q&q=lisp&friends=ozten
  },
  getUsername: function(url, pageType){
    if (pageType === this.PROFILE_PAGE) {
      var match = this.PROFILE_REGEX.exec(url);
      if (match.length == 2) {
        return match[1];
      } else {
        Oface.log("ERROR: getUsername(" + url + ", " + pageType + " called. Matched didn't have exactly 1 username piece, it had ");
      }
    } else {
      Oface.log("ERROR: getUsername(" + url + ", " + pageType + " called. Expected a PROFILE_PAGE types instead.");
    }
    
  },
  isSupportedPage: function(pageType){
    if(pageType == this.UNKNOWN_PAGE){
      return false;
    }
    return [this.HOME_PAGE, this.PROFILE_PAGE, this.LIST_PAGE,
            this.EVERYONE_PAGE, this.FRIENDS_PAGE].indexOf(pageType) != -1;
  }
}
CmdUtils.CreateCommand(Oface.WhatPageIsThis);
;CmdUtils.CreateCommand({
  name: "mobhat-version",
  homepage: "http://mobhat.restservice.org/",
  author: {
    name: "Austin King",
    email: "shout@ozten.com"
  },
  license: "GPL",
  description: "Shows the version that MOBhat thinks your using ;)",
  help: "Just run it, preview will show version",
  preview: function(pblock, input) {
    pblock.innerHTML = "Version: " + Oface.version;
  }
});
;
CmdUtils.CreateCommand({
    name: "mobhat-unittest",
    help: "Run the Oface unit tests",
    preview: function(pblock, input) {
        pblock.innerHTML = "Running unit tests " + Oface.version;
        var fails = 0, passes = 0;
        with(Oface.WhatPageIsThis) {
            assertRegexMatches(PROFILE_REGEX, "http://friendfeed.com/ozten", "Typical profile page");
            assertRegexMatches(PROFILE_REGEX, "http://friendfeed.com/ozten?start=30", "1 page in on a profile page");
            assertRegexMatches(PROFILE_REGEX, "http://friendfeed.com/ozten#ahash", "A page with a hash");
            
            assertRegexMatches(ROOMS_LIST_REGEX, "http://friendfeed.com/rooms", "The Rooms list, no slash");
            assertRegexMatches(ROOMS_LIST_REGEX, "http://friendfeed.com/rooms/", "The Rooms list");
        }
        pblock.innerHTML = "Passes: " + passes + " Faileds: " + fails;
        function assertRegexMatches(regex, string, message) {
            var msg = message || "";
            assert(msg, regex.test(string));
        }
        function assertRegexFails(regex, string, message) {
            var msg = message || "";
            assert(msg, ! regex.test(string));
        }
        function assert(assertString, value, otherValue) {
            switch (typeof value) {
                case "boolean":
                    if(value){
                        passes++;
                    } else {
                        fails++;
                        Utils.reportWarning("Expected true but was (false): '" +  assertString + "'");
                        //throw new AssertFailed("Expected true but was false: " + assertString);
                    }
                    break;
                default:
                    Utils.reportWarning("assert programming error, unknown type for " + value);
                    //throw "assert programming error, unknown type for " + value;
            }
            function AssertFailed(message) {
                this.message = message;
                this.name = "AssertFailed";
            }
        }
    },
    execute: function(input) {
    
    }                   
});